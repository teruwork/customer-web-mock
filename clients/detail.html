<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>顧客詳細</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div class="min-h-screen bg-gray-50 p-4 md:p-6">
    <h1 class="text-2xl font-bold mb-4" id="clientName">顧客詳細</h1>
    <div class="mb-4 flex justify-between items-center">
      <a href="../index.html" class="text-blue-600 underline">← 顧客一覧に戻る</a>
      <button onclick="openEditModal()" class="px-4 py-2 bg-yellow-500 text-white rounded">訂正</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white p-4 rounded shadow" id="basicInfo">
        <h2 class="font-semibold text-lg mb-2">基本情報</h2>
      </div>
      <div class="bg-white p-4 rounded shadow" id="contactInfo">
        <h2 class="font-semibold text-lg mb-2">担当者情報</h2>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6" id="summaryInfo">
      <h2 class="font-semibold text-lg mb-2">概況</h2>
      <p id="clientMemo" class="whitespace-pre-wrap min-h-[6rem] text-gray-800"></p>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6" id="salesHistory">
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold text-lg">販売実績</h2>
        <div class="text-sm text-gray-600 flex items-center gap-4">
          <span id="salesTarget"></span>
          <button onclick="addSalesRow()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">＋
            販売実績を追加</button>
        </div>
      </div>

      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">期</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">重量（t）</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">前年比</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">金額（千円）</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">前年比</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">単価（kg/円）</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">前年比</th>
            <th class="px-2 py-1 text-xs text-left text-gray-600 border border-gray-200">制御</th>
          </tr>
        </thead>
        <tbody id="salesBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6" id="productList">
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold text-lg">使用銘柄</h2>
        <button onclick="addProductRow()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">＋
          使用銘柄を追加</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border border-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">期</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">コード</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">製品名</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">紙袋</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">TB</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">バラ</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">合計（kg）</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">制御</th>
            </tr>
          </thead>
          <tbody id="productBody"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <label class="block font-semibold">面談履歴</label>
        <button onclick="addMeetingRow()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">＋
          面談履歴を追加</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border border-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">日付</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">商談先</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">商談相手</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">内容</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">要望・課題</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">次回アクション</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600 border border-gray-200">制御</th>
            </tr>
          </thead>
          <tbody id="meetings"></tbody>
        </table>
      </div>
    </div>

    <!-- 訂正モーダル -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow-lg w-full max-w-3xl overflow-y-auto max-h-screen">
        <h2 class="text-lg font-bold mb-4">顧客編集</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm">会社名 *</label><input id="name" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">得意先コード</label><input id="code" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">郵便番号</label><input id="postal" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">所在地</label><input id="address" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">電話番号</label><input id="phone" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">FAX番号</label><input id="fax" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">設立年月日</label><input id="established"
              class="w-full border rounded px-2 py-1" /></div>
          <div><label class="block text-sm">販売目標（t）</label><input id="target" class="w-full border rounded px-2 py-1" />
          </div>
          <div class="md:col-span-2"><label class="block text-sm">概況</label><input id="memo"
              class="w-full border rounded px-2 py-1" /></div>
        </div>
        <div class="mt-4">
          <label class="block font-semibold mb-2">担当者一覧</label>
          <div id="contacts"></div>
          <button onclick="addContactRow()" class="mt-2 px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">＋
            担当者を追加</button>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button onclick="closeModal()" class="px-4 py-2 border rounded">キャンセル</button>
          <button onclick="saveEdit()" class="px-4 py-2 bg-blue-600 text-white rounded">保存</button>
        </div>
      </div>
    </div>

    <script>
      const client = JSON.parse(localStorage.getItem('selectedClient'));
      if (client) {
        document.getElementById('clientName').textContent = client.name + ' - 顧客詳細';
        const basicInfo = `
          <p><strong>会社名:</strong> ${client.name}</p>
          <p><strong>所在地:</strong> ${client.address}</p>
          <p><strong>郵便番号:</strong> ${client.postal}</p>
          <p><strong>得意先コード:</strong> ${client.code}</p>
          <p><strong>設立:</strong> ${client.established}</p>
          <p><strong>電話番号:</strong> ${client.phone}</p>
          <p><strong>FAX:</strong> ${client.fax}</p>
        `;
        document.getElementById('basicInfo').insertAdjacentHTML('beforeend', basicInfo);
        document.getElementById('clientMemo').textContent = client.memo || "";
        client.contacts?.forEach(c => {
          const contact = `
            <div class="mb-3">
              <p><strong>名前:</strong> ${c.name}</p>
              <p><strong>メール:</strong> ${c.email}</p>
              <p><strong>メモ:</strong> ${c.note}</p>
            </div>`;
          document.getElementById('contactInfo').insertAdjacentHTML('beforeend', contact);
        });
        document.getElementById('salesTarget').textContent = client.target ? `販売目標 ${client.target} t` : '';
        const sales = client.sales || [];
        sales.forEach((s, i) => {
          const prev = sales[i - 1];
          const format = n => n?.toLocaleString?.() ?? "-";
          const diff = (curr, prev) => {
            if (prev === undefined || prev === 0) return "-";
            const d = ((curr - prev) / prev * 100).toFixed(1);
            return (d < 0 ? "▲" : "") + d + "%";
          };

          const price = s.amount && s.weight ? (s.amount * 1000 / s.weight) : 0;

          const html = `
            <tr>
              <td class="px-2 py-1 text-sm border border-gray-200">${s.term}</td>
              <td class="px-2 py-1 text-sm border border-gray-200 text-right">${format(s.weight)}</td>
              <td class="px-2 py-1 text-sm border border-gray-200 text-right">${diff(s.weight, prev?.weight)}</td>
              <td class="px-2 py-1 text-sm border border-gray-200 text-right">${format(s.amount)}</td>
              <td class="px-2 py-1 text-sm border border-gray-200 text-right">${diff(s.amount, prev?.amount)}</td>
              <td class="px-2 py-1 text-sm border border-gray-200 text-right">${format(Math.round(price))}</td>
              <td class="px-2 py-1 text-sm border border-gray-200 text-right">${diff(price, prev?.amount && prev?.weight ? prev.amount * 1000 / prev.weight : undefined)}</td>
              <td class="px-2 py-1 text-center border border-gray-200 control-col">
                <button class="text-red-500 text-sm mr-2" onclick="deleteSalesRow(this)">✕</button>
                <button class="text-blue-500 text-sm" onclick="editSalesRow(this)">✏️ 訂正</button>
              </td>
            </tr>
          `;
          document.getElementById("salesBody").insertAdjacentHTML("beforeend", html);
        });
        (client.products || []).forEach(p => {
          const tbody = document.getElementById("productBody");
          const tr = document.createElement("tr");

          const total = calculateProductTotal(p.paper, p.tb, p.bulk);

          tr.innerHTML = `
            <td class="px-2 py-1 text-sm border border-gray-200">${p.term}</td>
            <td class="px-2 py-1 text-sm border border-gray-200">${p.code}</td>
            <td class="px-2 py-1 text-sm border border-gray-200">${p.name}</td>
            <td class="px-2 py-1 text-sm border border-gray-200 text-right">${p.paper || ""}</td>
            <td class="px-2 py-1 text-sm border border-gray-200 text-right">${p.tb || ""}</td>
            <td class="px-2 py-1 text-sm border border-gray-200 text-right">${p.bulk?.toLocaleString?.() || ""}</td>
            <td class="px-2 py-1 text-sm border border-gray-200 text-right">${total}</td>
            <td class="px-2 py-1 text-center border border-gray-200 control-col">
              <button class="text-red-500 text-sm mr-2" onclick="deleteProductRow(this)">✕</button>
              <button class="text-blue-500 text-sm" onclick="editProductRow(this)">✏️ 訂正</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        (client.meetings || []).forEach(m => addMeetingRow(m, false));
      }

      function openEditModal() {
        const keys = ["name", "code", "postal", "address", "phone", "fax", "established", "memo", "target"];
        keys.forEach(id => document.getElementById(id).value = client[id] || "");
        const container = document.getElementById("contacts");
        container.innerHTML = "";
        (client.contacts || [{}]).forEach(addContactRow);
        const mContainer = document.getElementById("meetings");
        mContainer.innerHTML = "";
        (client.meetings || []).forEach(addMeetingRow);
        document.getElementById("modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }

      function addSalesRow(data = {}, isNew = true) {
        const tbody = document.getElementById("salesBody");
        const tr = document.createElement("tr");

        const term = data.term || "";
        const weight = data.weight || "";
        const amount = data.amount || "";

        tr.innerHTML = `
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 term" value="${term}"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 weight" value="${weight}" onchange="updateSalesRow(this)"></td>
          <td class="border px-2 py-1 text-sm text-center">-</td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 amount" value="${amount}" onchange="updateSalesRow(this)"></td>
          <td class="border px-2 py-1 text-sm text-center">-</td>
          <td class="border px-2 py-1 text-sm text-right unitPrice">-</td>
          <td class="border px-2 py-1 text-sm text-center">-</td>
          <td class="border px-2 py-1 text-center control-col">
          ${isNew
            ? `<button class="text-blue-600 text-sm" onclick="saveSalesRow(this)">保存</button>`
            : `<button class="text-red-500 text-sm" onclick="deleteSalesRow(this)">✕</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      }

      function saveSalesRow(btn) {
        const row = btn.closest("tr");
        const term = parseInt(row.querySelector(".term")?.value);
        const weight = parseFloat(row.querySelector(".weight")?.value);
        const amount = parseFloat(row.querySelector(".amount")?.value);

        if (!term || !weight || !amount) return alert("期・重量・金額は必須です");

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          const sales = clients[index].sales || [];

          // 編集か新規かを判断
          const existingRow = sales.findIndex(s => {
            return row.dataset.originalTerm && parseInt(row.dataset.originalTerm) === s.term &&
              row.dataset.originalWeight && parseFloat(row.dataset.originalWeight) === s.weight &&
              row.dataset.originalAmount && parseFloat(row.dataset.originalAmount) === s.amount;
          });

          if (existingRow !== -1) {
            // 編集：上書き
            sales[existingRow] = { term, weight, amount };
          } else {
            // 新規：追加
            sales.push({ term, weight, amount });
          }

          sales.sort((a, b) => a.term - b.term);
          clients[index].sales = sales;
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));

          location.reload();
        }
      }

      function editSalesRow(btn) {
        const row = btn.closest("tr");
        const tds = row.querySelectorAll("td");

        const term = tds[0].textContent.trim();
        const weight = tds[1].textContent.trim().replace(/,/g, "");
        const amount = tds[3].textContent.trim().replace(/,/g, "");

        row.dataset.originalTerm = term;
        row.dataset.originalWeight = weight;
        row.dataset.originalAmount = amount;

        row.innerHTML = `
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 term" value="${term}"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 weight" value="${weight}"></td>
          <td class="border px-2 py-1 text-sm text-center">-</td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 amount" value="${amount}"></td>
          <td class="border px-2 py-1 text-sm text-center">-</td>
          <td class="border px-2 py-1 text-sm text-right unitPrice">-</td>
          <td class="border px-2 py-1 text-sm text-center">-</td>
          <td class="border px-2 py-1 text-center control-col">
            <button class="text-blue-600 text-sm" onclick="saveSalesRow(this)">保存</button>
          </td>
        `;
      }

      function updateSalesRow(input) {
        const row = input.closest("tr");
        const weightInput = row.querySelector(".weight");
        const amountInput = row.querySelector(".amount");

        const weight = parseFloat(weightInput?.value || 0);
        const amount = parseFloat(amountInput?.value || 0);
        const unitPrice = row.querySelector(".unitPrice");

        if (weight > 0 && amount > 0) {
          const price = Math.round((amount * 1000) / weight);
          unitPrice.textContent = price.toLocaleString();
        } else {
          unitPrice.textContent = "-";
        }
      }

      function deleteSalesRow(btn) {
        const row = btn.closest("tr");
        const term = parseInt(row.children[0]?.textContent.trim());
        const weight = parseFloat(row.children[1]?.textContent.trim().replace(/,/g, ""));
        const amount = parseFloat(row.children[3]?.textContent.trim().replace(/,/g, ""));


        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].sales = (clients[index].sales || []).filter(s =>
            !(s.term === term && s.weight === weight && s.amount === amount)
          );
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));
          location.reload();
        }
      }

      <!-- 使用銘柄追加機能のロジック -->
      function addProductRow(data = {}, isNew = true) {
        const tbody = document.getElementById("productBody");
        const tr = document.createElement("tr");

        const term = data.term || "";
        const code = data.code || "";
        const name = data.name || "";
        const paper = data.paper || "";
        const tb = data.tb || "";
        const bulk = data.bulk || "";
        const total = calculateProductTotal(paper, tb, bulk);

        tr.innerHTML = `
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 term" value="${term}"></td>
          <td class="border px-2 py-1"><input type="text" class="w-full border rounded px-1 py-0.5 code" value="${code}"></td>
          <td class="border px-2 py-1"><input type="text" class="w-full border rounded px-1 py-0.5 name" value="${name}"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 paper" value="${paper}" onchange="updateProductTotal(this)"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 tb" value="${tb}" onchange="updateProductTotal(this)"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 bulk" value="${bulk}" onchange="updateProductTotal(this)"></td>
          <td class="border px-2 py-1 text-sm text-right total">${total}</td>
          <td class="border px-2 py-1 text-center control-col">
          ${isNew
            ? `<button class="text-blue-600 text-sm" onclick="saveProductRow(this)">保存</button>`
            : `
                <button class="text-red-500 text-sm mr-2" onclick="deleteProductRow(this)">✕</button>
                <button class="text-blue-500 text-sm" onclick="editProductRow(this)">✏️ 訂正</button>
          `}
          </td>
        `;
        tbody.appendChild(tr);
      }

      function calculateProductTotal(paper, tb, bulk) {
        const p = parseInt(paper || 0);
        const t = parseInt(tb || 0);
        const b = parseInt(bulk || 0);
        const total = (p * 20) + (t * 500) + b;
        return total ? total.toLocaleString() : "";
      }

      function updateProductTotal(input) {
        const row = input.closest("tr");
        const paper = row.querySelector(".paper")?.value;
        const tb = row.querySelector(".tb")?.value;
        const bulk = row.querySelector(".bulk")?.value;
        const totalCell = row.querySelector(".total");
        totalCell.textContent = calculateProductTotal(paper, tb, bulk);
      }

      function saveProductRow(btn) {
        const row = btn.closest("tr");
        const term = parseInt(row.querySelector(".term")?.value);
        const code = row.querySelector(".code")?.value.trim();
        const name = row.querySelector(".name")?.value.trim();
        const paper = parseInt(row.querySelector(".paper")?.value || 0);
        const tb = parseInt(row.querySelector(".tb")?.value || 0);
        const bulk = parseInt(row.querySelector(".bulk")?.value || 0);

        if (!term || !code || !name) return alert("期・コード・製品名は必須です");

        const newItem = { term, code, name, paper, tb, bulk };
        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].products = clients[index].products || [];
          // 編集時の上書きチェック
          const existingRow = row.dataset.originalTerm && row.dataset.originalCode && row.dataset.originalName
            ? clients[index].products.findIndex(p =>
              p.term == row.dataset.originalTerm &&
              p.code == row.dataset.originalCode &&
              p.name == row.dataset.originalName)
            : -1;

          if (existingRow !== -1) {
            // 上書き
            clients[index].products[existingRow] = newItem;
          } else {
            // 新規
            clients[index].products.push(newItem);
          }
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));

          row.querySelector(".control-col").innerHTML = `
            <button class="text-red-500 text-sm mr-2" onclick="deleteProductRow(this)">✕</button>
            <button class="text-blue-500 text-sm" onclick="editProductRow(this)">✏️ 訂正</button>
          `;

          location.reload();
        }
      }

      function editProductRow(btn) {
        const row = btn.closest("tr");
        const tds = row.querySelectorAll("td");

        const term = tds[0].textContent.trim();
        const code = tds[1].textContent.trim();
        const name = tds[2].textContent.trim();
        const paper = tds[3].textContent.trim();
        const tb = tds[4].textContent.trim();
        const bulk = tds[5].textContent.trim();

        // 元値を記録
        row.dataset.originalTerm = term;
        row.dataset.originalCode = code;
        row.dataset.originalName = name;

        row.innerHTML = `
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 term" value="${term}"></td>
          <td class="border px-2 py-1"><input type="text" class="w-full border rounded px-1 py-0.5 code" value="${code}"></td>
          <td class="border px-2 py-1"><input type="text" class="w-full border rounded px-1 py-0.5 name" value="${name}"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 paper" value="${paper}" onchange="updateProductTotal(this)"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 tb" value="${tb}" onchange="updateProductTotal(this)"></td>
          <td class="border px-2 py-1"><input type="number" class="w-full border rounded px-1 py-0.5 bulk" value="${bulk}" onchange="updateProductTotal(this)"></td>
          <td class="border px-2 py-1 text-sm text-right total">${calculateProductTotal(paper, tb, bulk)}</td>
          <td class="border px-2 py-1 text-center control-col">
            <button class="text-blue-600 text-sm" onclick="saveProductRow(this)">保存</button>
          </td>
        `;
      }


      function deleteProductRow(btn) {
        const row = btn.closest("tr");
        const term = parseInt(row.querySelector(".term")?.value);
        const code = row.querySelector(".code")?.value.trim();
        const name = row.querySelector(".name")?.value.trim();

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].products = (clients[index].products || []).filter(p =>
            !(p.term === term && p.code === code && p.name === name)
          );
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));
        }

        row.remove();
      }

      function addMeetingRow(data = {}, isNew = true) {
        const container = document.getElementById("meetings");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1"><input type="date" value="${data.date || ''}" class="w-full border rounded px-1 py-0.5"></td>
          <td class="border px-2 py-1"><input placeholder="商談先" value="${data.place || ''}" class="w-full border rounded px-1 py-0.5"></td>
          <td class="border px-2 py-1"><input placeholder="商談相手" value="${data.attendees || ''}" class="w-full border rounded px-1 py-0.5"></td>
          <td class="border px-2 py-1"><textarea placeholder="内容" class="w-full border rounded px-1 py-0.5">${data.content || ''}</textarea></td>
          <td class="border px-2 py-1"><textarea placeholder="要望・課題" class="w-full border rounded px-1 py-0.5">${data.issues || ''}</textarea></td>
          <td class="border px-2 py-1"><textarea placeholder="次回アクション" class="w-full border rounded px-1 py-0.5">${data.next || ''}</textarea></td>
          <td class="border px-2 py-1 text-center control-col">
          ${isNew
            ? `<button class="text-blue-600 text-sm" onclick="saveMeetingRow(this)">保存</button>`
            : `<button class="text-red-500 text-sm" onclick="deleteMeetingRow(this)">✕</button>`}
          </td>
        `;
        container.appendChild(tr);
      }

      function saveMeetingRow(btn) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll("input, textarea");
        const newMeeting = {
          date: inputs[0].value,
          place: inputs[1].value,
          attendees: inputs[2].value,
          content: inputs[3].value,
          issues: inputs[4].value,
          next: inputs[5].value
        };

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].meetings = clients[index].meetings || [];
          clients[index].meetings.push(newMeeting);
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));

          // update row: 保存 → 削除ボタンに変える
          row.querySelector(".control-col").innerHTML =
            `<button class="text-red-500 text-sm" onclick="deleteMeetingRow(this)">✕</button>`;
        }
      }

      function deleteMeetingRow(btn) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll("input, textarea");
        const deleted = {
          date: inputs[0].value,
          place: inputs[1].value,
          attendees: inputs[2].value,
          content: inputs[3].value,
          issues: inputs[4].value,
          next: inputs[5].value
        };

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].meetings = (clients[index].meetings || []).filter(m =>
            !(m.date === deleted.date &&
              m.place === deleted.place &&
              m.attendees === deleted.attendees &&
              m.content === deleted.content &&
              m.issues === deleted.issues &&
              m.next === deleted.next)
          );
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));
        }

        row.remove();
      }

      function addContactRow(data = {}) {
        const container = document.getElementById("contacts");
        const div = document.createElement("div");
        div.className = "flex gap-2 mb-2 items-center";
        div.innerHTML = `
          <input placeholder="名前" class="border px-2 py-1 rounded w-1/3" value="${data.name || ''}" />
          <input placeholder="メール" class="border px-2 py-1 rounded w-1/3" value="${data.email || ''}" />
          <input placeholder="メモ" class="border px-2 py-1 rounded w-1/3" value="${data.note || ''}" />
          <button onclick="this.parentNode.remove()" class="text-red-500 text-sm">✕</button>
        `;
        container.appendChild(div);
      }

      function saveEdit() {
        const updated = {};
        ["name", "code", "postal", "address", "phone", "fax", "established", "memo", "target"].forEach(id => {
          updated[id] = document.getElementById(id).value.trim();
        });

        const contacts = [];
        document.querySelectorAll("#contacts > div").forEach(div => {
          const [name, email, note] = div.querySelectorAll("input");
          if (name.value.trim()) {
            contacts.push({ name: name.value.trim(), email: email.value.trim(), note: note.value.trim() });
          }
        });
        updated.contacts = contacts;

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const index = clients.findIndex(c => c.name === client.name && c.code === client.code);
        if (index !== -1) {
          updated.products = client.products || [];
          updated.sales = client.sales || [];
          clients[index] = updated;
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(updated));
          location.reload();
        }
      }
    </script>
</body>

</html>