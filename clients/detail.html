<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>顧客詳細</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div class="min-h-screen bg-gray-50 p-4 md:p-6">
    <h1 class="text-2xl font-bold mb-4" id="clientName">顧客詳細</h1>
    <div class="mb-4 flex justify-between items-center">
      <a href="../index.html" class="text-blue-600 underline">← 顧客一覧に戻る</a>
      <button onclick="openEditModal()" class="px-4 py-2 bg-yellow-500 text-white rounded">訂正</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white p-4 rounded shadow" id="basicInfo">
        <h2 class="font-semibold text-lg mb-2">基本情報</h2>
      </div>
      <div class="bg-white p-4 rounded shadow" id="contactInfo">
        <h2 class="font-semibold text-lg mb-2">担当者情報</h2>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6" id="summaryInfo">
      <h2 class="font-semibold text-lg mb-2">概況</h2>
      <p id="clientMemo" class="whitespace-pre-wrap min-h-[6rem] text-gray-800"></p>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <label class="block font-semibold">面談履歴</label>
        <button onclick="addMeetingRow()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">＋
          面談履歴を追加</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border border-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1 text-left text-xs text-gray-600">日付</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600">商談先</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600">商談相手</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600">内容</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600">要望・課題</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600">次回アクション</th>
              <th class="px-2 py-1 text-left text-xs text-gray-600">制御</th>
            </tr>
          </thead>
          <tbody id="meetings"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6" id="productList">
      <h2 class="font-semibold text-lg mb-2">取り扱い商品一覧</h2>
      <ul id="productItems" class="list-disc list-inside"></ul>
    </div>

    <div class="bg-white p-4 rounded shadow" id="salesHistory">
      <h2 class="font-semibold text-lg mb-2">販売実績</h2>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">年月</th>
            <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">商品名</th>
            <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">数量</th>
            <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">金額</th>
          </tr>
        </thead>
        <tbody id="salesBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- 訂正モーダル -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow-lg w-full max-w-3xl overflow-y-auto max-h-screen">
        <h2 class="text-lg font-bold mb-4">顧客編集</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm">会社名 *</label><input id="name" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">得意先コード</label><input id="code" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">郵便番号</label><input id="postal" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">所在地</label><input id="address" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">電話番号</label><input id="phone" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">FAX番号</label><input id="fax" class="w-full border rounded px-2 py-1" />
          </div>
          <div><label class="block text-sm">設立年月日</label><input id="established"
              class="w-full border rounded px-2 py-1" /></div>
          <div class="md:col-span-2"><label class="block text-sm">顧客メモ</label><input id="memo"
              class="w-full border rounded px-2 py-1" /></div>
        </div>
        <div class="mt-4">
          <label class="block font-semibold mb-2">担当者一覧</label>
          <div id="contacts"></div>
          <button onclick="addContactRow()" class="mt-2 px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded">＋
            担当者を追加</button>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button onclick="closeModal()" class="px-4 py-2 border rounded">キャンセル</button>
          <button onclick="saveEdit()" class="px-4 py-2 bg-blue-600 text-white rounded">保存</button>
        </div>
      </div>
    </div>

    <script>
      const client = JSON.parse(localStorage.getItem('selectedClient'));
      if (client) {
        document.getElementById('clientName').textContent = client.name + ' - 顧客詳細';
        const basicInfo = `
          <p><strong>会社名:</strong> ${client.name}</p>
          <p><strong>所在地:</strong> ${client.address}</p>
          <p><strong>郵便番号:</strong> ${client.postal}</p>
          <p><strong>得意先コード:</strong> ${client.code}</p>
          <p><strong>設立:</strong> ${client.established}</p>
          <p><strong>電話番号:</strong> ${client.phone}</p>
          <p><strong>FAX:</strong> ${client.fax}</p>
        `;
        document.getElementById('basicInfo').insertAdjacentHTML('beforeend', basicInfo);
        document.getElementById('clientMemo').textContent = client.memo || "";
        client.contacts?.forEach(c => {
          const contact = `
            <div class="mb-3">
              <p><strong>名前:</strong> ${c.name}</p>
              <p><strong>メール:</strong> ${c.email}</p>
              <p><strong>メモ:</strong> ${c.note}</p>
            </div>`;
          document.getElementById('contactInfo').insertAdjacentHTML('beforeend', contact);
        });
        (client.meetings || []).forEach(m => addMeetingRow(m, false));
        client.products?.forEach(p => {
          document.getElementById('productItems').insertAdjacentHTML('beforeend', `<li>${p}</li>`);
        });
        client.sales?.forEach(s => {
          const row = `
            <tr>
              <td class="px-4 py-2 text-sm">${s.date}</td>
              <td class="px-4 py-2 text-sm">${s.product}</td>
              <td class="px-4 py-2 text-sm">${s.quantity}</td>
              <td class="px-4 py-2 text-sm">${s.amount}</td>
            </tr>`;
          document.getElementById('salesBody').insertAdjacentHTML('beforeend', row);
        });
      }

      function openEditModal() {
        const keys = ["name", "code", "postal", "address", "phone", "fax", "established", "memo"];
        keys.forEach(id => document.getElementById(id).value = client[id] || "");
        const container = document.getElementById("contacts");
        container.innerHTML = "";
        (client.contacts || [{}]).forEach(addContactRow);
        const mContainer = document.getElementById("meetings");
        mContainer.innerHTML = "";
        (client.meetings || []).forEach(addMeetingRow);
        document.getElementById("modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }

      function addMeetingRow(data = {}, isNew = true) {
        const container = document.getElementById("meetings");
        const tr = document.createElement("tr");
        tr.innerHTML = `
    <td class="border px-2 py-1"><input type="date" value="${data.date || ''}" class="w-full border rounded px-1 py-0.5"></td>
    <td class="border px-2 py-1"><input placeholder="商談先" value="${data.place || ''}" class="w-full border rounded px-1 py-0.5"></td>
    <td class="border px-2 py-1"><input placeholder="商談相手" value="${data.attendees || ''}" class="w-full border rounded px-1 py-0.5"></td>
    <td class="border px-2 py-1"><textarea placeholder="内容" class="w-full border rounded px-1 py-0.5">${data.content || ''}</textarea></td>
    <td class="border px-2 py-1"><textarea placeholder="要望・課題" class="w-full border rounded px-1 py-0.5">${data.issues || ''}</textarea></td>
    <td class="border px-2 py-1"><textarea placeholder="次回アクション" class="w-full border rounded px-1 py-0.5">${data.next || ''}</textarea></td>
    <td class="border px-2 py-1 text-center control-col">
      ${isNew
            ? `<button class="text-blue-600 text-sm" onclick="saveMeetingRow(this)">保存</button>`
            : `<button class="text-red-500 text-sm" onclick="deleteMeetingRow(this)">✕</button>`}
    </td>
  `;
        container.appendChild(tr);
      }

      function saveMeetingRow(btn) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll("input, textarea");
        const newMeeting = {
          date: inputs[0].value,
          place: inputs[1].value,
          attendees: inputs[2].value,
          content: inputs[3].value,
          issues: inputs[4].value,
          next: inputs[5].value
        };

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].meetings = clients[index].meetings || [];
          clients[index].meetings.push(newMeeting);
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));

          // update row: 保存 → 削除ボタンに変える
          row.querySelector(".control-col").innerHTML =
            `<button class="text-red-500 text-sm" onclick="deleteMeetingRow(this)">✕</button>`;
        }
      }

      function deleteMeetingRow(btn) {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll("input, textarea");
        const deleted = {
          date: inputs[0].value,
          place: inputs[1].value,
          attendees: inputs[2].value,
          content: inputs[3].value,
          issues: inputs[4].value,
          next: inputs[5].value
        };

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const selected = JSON.parse(localStorage.getItem("selectedClient") || "{}");
        const index = clients.findIndex(c => c.name === selected.name && c.code === selected.code);

        if (index !== -1) {
          clients[index].meetings = (clients[index].meetings || []).filter(m =>
            !(m.date === deleted.date &&
              m.place === deleted.place &&
              m.attendees === deleted.attendees &&
              m.content === deleted.content &&
              m.issues === deleted.issues &&
              m.next === deleted.next)
          );
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(clients[index]));
        }

        row.remove();
      }

      function addContactRow(data = {}) {
        const container = document.getElementById("contacts");
        const div = document.createElement("div");
        div.className = "flex gap-2 mb-2 items-center";
        div.innerHTML = `
          <input placeholder="名前" class="border px-2 py-1 rounded w-1/3" value="${data.name || ''}" />
          <input placeholder="メール" class="border px-2 py-1 rounded w-1/3" value="${data.email || ''}" />
          <input placeholder="メモ" class="border px-2 py-1 rounded w-1/3" value="${data.note || ''}" />
          <button onclick="this.parentNode.remove()" class="text-red-500 text-sm">✕</button>
        `;
        container.appendChild(div);
      }

      function saveEdit() {
        const updated = {};
        ["name", "code", "postal", "address", "phone", "fax", "established", "memo"].forEach(id => {
          updated[id] = document.getElementById(id).value.trim();
        });

        const contacts = [];
        document.querySelectorAll("#contacts > div").forEach(div => {
          const [name, email, note] = div.querySelectorAll("input");
          if (name.value.trim()) {
            contacts.push({ name: name.value.trim(), email: email.value.trim(), note: note.value.trim() });
          }
        });
        updated.contacts = contacts;

        // const meetings = [];
        // document.querySelectorAll("#meetings > div").forEach(div => {
        //   const inputs = div.querySelectorAll("input, textarea");
        //   meetings.push({
        //     date: inputs[0].value,
        //     place: inputs[1].value,
        //     attendees: inputs[2].value,
        //     content: inputs[3].value,
        //     issues: inputs[4].value,
        //     next: inputs[5].value
        //   });
        // });
        // updated.meetings = meetings;

        const clients = JSON.parse(localStorage.getItem("clients") || "[]");
        const index = clients.findIndex(c => c.name === client.name && c.code === client.code);
        if (index !== -1) {
          // updated.meetings = client.meetings || [];
          updated.products = client.products || [];
          updated.sales = client.sales || [];
          clients[index] = updated;
          localStorage.setItem("clients", JSON.stringify(clients));
          localStorage.setItem("selectedClient", JSON.stringify(updated));
          location.reload();
        }
      }
    </script>
</body>

</html>